!function(t,n){typeof exports==='object'&&typeof module!=='undefined'?module.exports=n():typeof define==='function'&&define.amd?define('HyperGard',n):(t.HyperGard=n())}(this,(function(){"use strict";var t={},n=[].slice,e=t.toString,r=function(n){if(n==null){return n+''}return typeof n==='object'||typeof n==='function'?t[e.call(n)]||'object':typeof n},o=function(t){return r(t)==='buffer'||r(t)==='date'||r(t)==='regexp'},u=function(t){var n=r(t),e;if(n==='buffer'){e=new Buffer(t.length);t.copy(e);return e}if(n==='date'){return new Date(t.getTime())}if(n==='regexp'){return new RegExp(t)}throw new Error('Unexpected situation')},i=function(t){var n=[];t.forEach(function(t,e){r(t)==='object'?(Array.isArray(t)?(n[e]=i(t)):o(t)?(n[e]=u(t)):(n[e]=c({},t))):(n[e]=t)});return n},c=function(){if(arguments.length<1||r(arguments[0])!=='object'){return!1}if(arguments.length<2){return arguments[0]}var t=arguments[0],e=n.call(arguments,1),f,a;e.forEach(function(n){if(r(n)!=='object'||Array.isArray(n)){return}Object.keys(n).forEach(function(e){a=t[e];f=n[e];f!==t&&(r(f)!=='object'||f===null?(t[e]=f):Array.isArray(f)?(t[e]=i(f)):o(f)?(t[e]=u(f)):r(a)!=='object'||a===null||Array.isArray(a)?(t[e]=c({},f)):(t[e]=c(a,f)))})});return t};['Boolean','Number','String','Function','Array','Date','RegExp','Object','Error'].forEach(function(n){t["[object "+n+"]"]=n.toLowerCase()});function f(){var t=['+','#','.','/',';','?','&'],n=/\{([^\{\}]+)\}|([^\{\}]+)/g,e=/([^:\*]*)(?::(\d+)|(\*))?/,r=function(t){return t.split(/(%[0-9A-Fa-f]{2})/g).map(function(t){/%[0-9A-Fa-f]/.test(t)||(t=encodeURI(t));return t}).join('')},o=function(t,n,e){n=t==='+'||t==='#'?r(n):encodeURIComponent(n);return e?encodeURIComponent(e)+'='+n:n},u=function(t){return t!==void 0&&t!==null},i=function(t){return t===';'||t==='&'||t==='?'},c=function(t,n,e,r){var c=t[e],f=[];if(typeof c!=='undefined'&&c!==null){if(typeof c==='string'||typeof c==='number'||typeof c==='boolean')c=c.toString(),r&&r!=='*'&&(c=c.substring(0,parseInt(r,10))),f.push(o(n,c,i(n)?e:null));else{if(r==='*')Array.isArray(c)?c.filter(u).forEach(function(t){f.push(o(n,t,i(n)?e:null))}):Object.keys(c).forEach(function(t){u(c[t])&&f.push(o(n,c[t],t))});else{var a=[];Array.isArray(c)?c.filter(u).forEach(function(t){a.push(o(n,t,''))}):Object.keys(c).forEach(function(t){u(c[t])&&(a.push(encodeURIComponent(t)),a.push(o(n,c[t].toString(),'')))});i(n)?f.push(encodeURIComponent(e)+'='+a.join(',')):a.length!==0&&f.push(a.join(','))}}}else n===';'?f.push(encodeURIComponent(e)):c===''&&(n==='&'||n==='?')?f.push(encodeURIComponent(e)+'='):c===''&&f.push('');return f};this.expand=function(o,u){return o.replace(n,function(n,i,f){var a;if(i){var s,l=[];t.indexOf(i.charAt(0))!==-1&&(s=i.charAt(0),i=i.substr(1),(o.match(/\?/g)||[]).length>1&&(s='&'));i.split(/,/g).forEach(function(t){var n=e.exec(t);l.push.apply(l,c(u,s,n[1],n[2]||n[3]))});if(s&&s!=='+'){var h=',';s==='?'?(h='&'):s!=='#'&&(h=s);a=(l.length?s:'')+l.join(h)}else a=l.join(',')}else a=r(f);return a})};this.extractParams=function(e){var r=[];e.replace(n,function(n,e){e&&(t.indexOf(e.charAt(0))!==-1&&(e=e.substr(1)),r=r.concat(e.split(/,/g)))});return r}}var a=new f;function s(){var t=/^([A-Za-z]+)?(:?\/\/)([0-9.\-A-Za-z]*)(?::(\d+))?(.*)$/,n=/([^?#]*)?(?:\?([^#]*))?(?:#(.*))?$/;this.normalizepath=function(t){if(!t||t==='/'){return'/'}var n=t.split('/'),e=[];n[0]&&e.push('');n.forEach(function(t){t==='..'?(e.length>1?e.pop():e.push(t)):t!=='.'&&e.push(t)});return e.join('/')||'/'};this.urlnormalize=function(t){var n=this.urlsplit(t);switch(n.scheme){case 'file':n.query='';n.fragment='';break;case 'http':;case 'https':(n.scheme==='http'&&n.port==80||n.scheme==='https'&&n.port==443)&&(delete n.port,n.netloc=n.hostname);break;default:return t}n.path=this.normalizepath(n.path);return this.urlunsplit(n)};this.urldefrag=function(t){var n=t.indexOf('#');return n===-1?[t,'']:[t.substr(0,n),t.substr(n+1)]};this.urlsplit=function(e,r,o){o=o!==!1;var u,i={},c=(e||'').match(t);c?(i.scheme=c[1]||r||'',i.hostname=c[3].toLowerCase()||'',i.port=parseInt(c[4],10)||'',i.netloc=c[3],c[4]&&(i.netloc+=':'+c[4]),u=c[5]):(i.scheme=r||'',i.netloc='',i.hostname='',u=e);i.scheme=i.scheme.toLowerCase();c=u.match(n);i.path=c[1]||'';i.query=c[2]||'';i.fragment=o?c[3]||'':'';return i};this.urlunsplit=function(t){var n='';t.scheme&&(n+=t.scheme+'://');t.netloc?(n===''&&(n+='//'),n+=t.netloc):t.hostname&&(n===''&&(n+='//'),n+=t.hostname,t.port&&(n+=':'+t.port));t.path&&(n+=t.path);t.query&&(n+='?'+t.query);t.fragment&&(n+='#'+t.fragment);return n};this.urljoin=function(t,n,e){typeof e==='undefined'&&(e=!0);var r=this.urlsplit(n);if(r.scheme){return!e?n:this.urldefrag(n)[0]}var o=this.urlsplit(t);o.scheme||(o.scheme=r.scheme);(!o.netloc||!o.hostname)&&(o.netloc=r.netloc,o.hostname=r.hostname,o.port=r.port);if(r.path.length>0){if(r.path.charAt(0)==='/')o.path=r.path;else{var u=o.path.lastIndexOf('/');u===-1?(o.path=r.path):(o.path=o.path.substr(0,u)+'/'+r.path)}}o.path=this.normalizepath(o.path);o.query=r.query;o.fragment=e?r.fragment:'';return this.urlunsplit(o)}}var l=new s;var h='5.2.0',p={preloadHomepage:!0,cacheHomepage:!1,debug:!1,xhr:{headers:{Accept:'application/hal+json, application/json, */*; q=0.01','X-HyperGard':h}}},d=/^(_embedded|_links|_forms)$/,m=/^(head|get)$/i,g=[].concat,y=Object.keys,w=function(t){return!!t&&{}.toString.call(t)==='[object Object]'},A=function(t){return t.status>=200&&t.status<300?t:Promise.reject(t instanceof Response?t:new Response('',{status:503,statusText:'Possible CORS error'}))},j=function(t){return new Promise(function(n,e){setTimeout(function(){e({error:{code:'0011',msg:'Fetch timeout',timeout:t}})},t)})},b=function(t,n){var e=c({},p.xhr,n);return Promise.race([j(n.timeout||6e4),fetch(t,e)]).then(A)},E=function(t){return Object.keys(t).map(function(n){return encodeURIComponent(n)+'='+encodeURIComponent(t[n])}).join('&')},P=function(t,n){var e,r=!1,o=c({},p,n||{}),u={},i=function(t){var n={};(t||[]).forEach(function(t){t.name&&(n[t.name]=t)});return n},f=function(t,n){var e={};y(t).forEach(function(r){e[r]=Array.isArray(t[r])?t[r].map(function(t){return new A(t,n)}):new A(t[r],n)});return e},s=function(t,n,e,r){var c={},a=((n._links||{}).self||{}).href||'',s=[],l=f(n._embedded||{},t);y(n).forEach(function(t){d.test(t)||(this[t]=n[t])},c);t.getAction=function(t,e){if(!s[t]){s[t]=[];var r=i((n._links||{}).curies),o=i((n._forms||{}).curies),u=String(t).split(':')[0]||'';g.call([],(n._links||{})[t]).forEach(function(n){n&&(n.curie=r[u],s[t].push(new h(this,t,n,e,'link')))},this);g.call([],(n._forms||{})[t]).forEach(function(n){n&&(n.curie=o[u],s[t].push(new h(this,t,n,e,'form')))},this)}return s[t].map(function(t){return t.setParams(e)})};t.getBase=function(){return r||e.getBase()};t.getEmbedded=function(t){return l[t]};t.fetchEmbedded=function(t,n){return this.hasEmbedded(t)?Promise.resolve({data:this.getEmbedded(t)}):this.getFirstAction(t).fetch(n)};t.getFirstAction=function(t,n){return this.getAction(t,n)[0]||new h(this,t,{},{},'none')};t.getParent=function(){return e};t.getProp=function(t){return c[t]};t.getProps=function(){return c};t.hasAction=function(n){return t.hasLink(n)||t.hasForm(n)};t.hasEmbedded=function(t){return!!l[t]};t.hasForm=function(n){return t.listActions().forms.indexOf(n)>=0};t.hasLink=function(n){return t.listActions().links.indexOf(n)>=0};t.listActions=function(){var t=function(t){return t!=='curies'};return{links:y(n._links||{}).filter(t),forms:y(n._forms||{}).filter(t)}};t.listEmbedded=function(){return y(l)};o.debug&&(t.resource=n);r||(t.getRoot=function(){var t;do{t=this.getParent()}while(!(t instanceof j));return t});a&&(u[a]=t)},h=function(t,n,e,r,o){var u=this,i=(e.href||e.action||'').replace(/^#/,''),c=e.method||(o==='form'?'POST':'GET'),f='',s='';u.getActionName=function(){return n};u.getActionType=function(){return o};u.getActionUrl=function(){return f};u.getMethod=function(){return c};u.getParams=function(){return a.extractParams(i)};u.getRawActionUrl=function(){return i};u.getTitle=function(){return e.title||''};u.isTemplated=function(){return e.templated||!1};u.setParams=function(n){f=e.templated?a.expand(i,n||{}):i;f&&(f=l.urljoin(e.curie?e.curie.href:t.getBase(),f));o==='form'&&(e.fields&&w(n)?(s={},y(e.fields).forEach(function(t){n.hasOwnProperty(t)?(s[t]=n[t]):e.fields[t].hasOwnProperty('default')&&(s[t]=e.fields[t]['default'])})):n&&(s=JSON.stringify(n)),m.test(c)&&s&&(f=l.urljoin(f,'?'+E(s)),s=''));return u};o==='form'&&(u.getFields=function(){return e.fields||{}},u.getPayload=function(){return s});e.curie&&(u.getDocUrl=function(){return a.expand(e.curie.href,{rel:n.split(':')[1]})});u.setParams(r)},A=function(t,n){return s(this,t||{},n)},j=function(t,n){return s(this,n,this,t)};h.prototype.fetch=function(t){t||(t={});var n=t.url||this.getActionUrl(),e=this.getRawActionUrl(),r=this.getActionName(),i=this.getPayload?this.getPayload():'',f=c({method:this.getMethod(),action:r},o.xhr,t),a=function(t){if(t.status===204){return Promise.resolve({action:r,data:'',xhr:t})}function e(t){if(!f.returnRawData&&w(t)){return new j(n,t)}return t}return t.json().then(function(n){return{action:r,data:e(n),xhr:t}},function(){return{action:r,data:t.text(),xhr:t}})},s=function(t){return Promise.reject(t instanceof Response?{error:{action:r,code:'0021',msg:'Failed to retrieve action'},xhr:t}:t)};!m.test(f.method)&&w(i)&&(f.headers['Content-Type']='application/x-www-form-urlencoded',f.body=E(i));if(!n){return Promise.reject({error:{action:r,code:'0020',msg:'Url is not provided for this action'}})}else if(f.method==='GET'&&!t.force&&u.hasOwnProperty(e)){return Promise.resolve({action:r,data:u[e]})}return b(n,f).then(a,s)};this.fetch=function(){var n=c({method:'GET',action:'homepage'},o.xhr),u=function(n){o.cacheHomepage||(r=!1);return n.json().then(function(e){return w(e)?{data:new j(t,e),xhr:n}:Promise.reject()})['catch'](function(){return Promise.reject({error:{code:'0002',msg:'Could not parse homepage'},xhr:n})})},i=function(t){r=!1;return Promise.reject(t instanceof Response?{error:{code:'0001',msg:'Failed to retrieve homepage'},xhr:t}:t)};if(!t){return Promise.reject({error:{code:'0000',msg:'API endpoint was not provided'}})}r||(r=!0,e=b(t,n).then(u,i));return e};this.setOptions=function(t){c(o,t||{});return this};this.getOptions=function(){return o};this.parse=function(n){return new j(t,n||{})};o.preloadHomepage&&this.fetch()};P.prototype.version=h;function x(t){b=(function(n){return function(e,r){return t(e,r,n)}})(b)}P.prototype.applyMiddlewareStack=function(t){var n;t&&Array.isArray(t)&&t.length&&(n=t.reverse(),n.forEach(x))};return P}))