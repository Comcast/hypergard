!function(n,t){typeof exports==='object'&&typeof module!=='undefined'?module.exports=t():typeof define==='function'&&define.amd?define('HyperGard',t):(n.HyperGard=t())}(this,(function(){"use strict";var n={},t=[].slice,e=n.toString,r=function(t){if(t==null){return t+''}return typeof t==='object'||typeof t==='function'?n[e.call(t)]||'object':typeof t},u=function(n){return r(n)==='buffer'||r(n)==='date'||r(n)==='regexp'},o=function(n){var t=r(n),e;if(t==='buffer'){e=new Buffer(n.length);n.copy(e);return e}if(t==='date'){return new Date(n.getTime())}if(t==='regexp'){return new RegExp(n)}throw new Error('Unexpected situation')},i=function(n){var t=[];n.forEach(function(n,e){r(n)==='object'?(Array.isArray(n)?(t[e]=i(n)):u(n)?(t[e]=o(n)):(t[e]=c({},n))):(t[e]=n)});return t},c=function(){if(arguments.length<1||r(arguments[0])!=='object'){return!1}if(arguments.length<2){return arguments[0]}var n=arguments[0],e=t.call(arguments,1),f,s;e.forEach(function(t){if(r(t)!=='object'||Array.isArray(t)){return}Object.keys(t).forEach(function(e){s=n[e];f=t[e];f!==n&&(r(f)!=='object'||f===null?(n[e]=f):Array.isArray(f)?(n[e]=i(f)):u(f)?(n[e]=o(f)):r(s)!=='object'||s===null||Array.isArray(s)?(n[e]=c({},f)):(n[e]=c(s,f)))})});return n};['Boolean','Number','String','Function','Array','Date','RegExp','Object','Error'].forEach(function(t){n["[object "+t+"]"]=t.toLowerCase()});function f(){var n=['+','#','.','/',';','?','&'],t=/\{([^\{\}]+)\}|([^\{\}]+)/g,e=/([^:\*]*)(?::(\d+)|(\*))?/,r=function(n){return n.split(/(%[0-9A-Fa-f]{2})/g).map(function(n){/%[0-9A-Fa-f]/.test(n)||(n=encodeURI(n));return n}).join('')},u=function(n,t,e){t=n==='+'||n==='#'?r(t):encodeURIComponent(t);return e?encodeURIComponent(e)+'='+t:t},o=function(n){return n!==void 0&&n!==null},i=function(n){return n===';'||n==='&'||n==='?'},c=function(n,t,e,r){var c=n[e],f=[];if(typeof c!=='undefined'&&c!==null){if(typeof c==='string'||typeof c==='number'||typeof c==='boolean')c=c.toString(),r&&r!=='*'&&(c=c.substring(0,parseInt(r,10))),f.push(u(t,c,i(t)?e:null));else{if(r==='*')Array.isArray(c)?c.filter(o).forEach(function(n){f.push(u(t,n,i(t)?e:null))}):Object.keys(c).forEach(function(n){o(c[n])&&f.push(u(t,c[n],n))});else{var s=[];Array.isArray(c)?c.filter(o).forEach(function(n){s.push(u(t,n,''))}):Object.keys(c).forEach(function(n){o(c[n])&&(s.push(encodeURIComponent(n)),s.push(u(t,c[n].toString(),'')))});i(t)?f.push(encodeURIComponent(e)+'='+s.join(',')):s.length!==0&&f.push(s.join(','))}}}else t===';'?f.push(encodeURIComponent(e)):c===''&&(t==='&'||t==='?')?f.push(encodeURIComponent(e)+'='):c===''&&f.push('');return f};this.expand=function(u,o){return u.replace(t,function(t,i,f){var s;if(i){var a,l=[];n.indexOf(i.charAt(0))!==-1&&(a=i.charAt(0),i=i.substr(1),(u.match(/\?/g)||[]).length>1&&(a='&'));i.split(/,/g).forEach(function(n){var t=e.exec(n);l.push.apply(l,c(o,a,t[1],t[2]||t[3]))});if(a&&a!=='+'){var h=',';a==='?'?(h='&'):a!=='#'&&(h=a);s=(l.length?a:'')+l.join(h)}else s=l.join(',')}else s=r(f);return s})};this.extractParams=function(e){var r=[];e.replace(t,function(t,e){e&&(n.indexOf(e.charAt(0))!==-1&&(e=e.substr(1)),r=r.concat(e.split(/,/g)))});return r}}var s=new f;function a(){var n=/^([A-Za-z]+)?(:?\/\/)([0-9.\-A-Za-z]*)(?::(\d+))?(.*)$/,t=/([^?#]*)?(?:\?([^#]*))?(?:#(.*))?$/;this.normalizepath=function(n){if(!n||n==='/'){return'/'}var t=n.split('/'),e=[];t[0]&&e.push('');t.forEach(function(n){n==='..'?(e.length>1?e.pop():e.push(n)):n!=='.'&&e.push(n)});return e.join('/')||'/'};this.urlnormalize=function(n){var t=this.urlsplit(n);switch(t.scheme){case 'file':t.query='';t.fragment='';break;case 'http':;case 'https':(t.scheme==='http'&&t.port==80||t.scheme==='https'&&t.port==443)&&(delete t.port,t.netloc=t.hostname);break;default:return n}t.path=this.normalizepath(t.path);return this.urlunsplit(t)};this.urldefrag=function(n){var t=n.indexOf('#');return t===-1?[n,'']:[n.substr(0,t),n.substr(t+1)]};this.urlsplit=function(e,r,u){u=u!==!1;var o,i={},c=(e||'').match(n);c?(i.scheme=c[1]||r||'',i.hostname=c[3].toLowerCase()||'',i.port=parseInt(c[4],10)||'',i.netloc=c[3],c[4]&&(i.netloc+=':'+c[4]),o=c[5]):(i.scheme=r||'',i.netloc='',i.hostname='',o=e);i.scheme=i.scheme.toLowerCase();c=o.match(t);i.path=c[1]||'';i.query=c[2]||'';i.fragment=u?c[3]||'':'';return i};this.urlunsplit=function(n){var t='';n.scheme&&(t+=n.scheme+'://');n.netloc?(t===''&&(t+='//'),t+=n.netloc):n.hostname&&(t===''&&(t+='//'),t+=n.hostname,n.port&&(t+=':'+n.port));n.path&&(t+=n.path);n.query&&(t+='?'+n.query);n.fragment&&(t+='#'+n.fragment);return t};this.urljoin=function(n,t,e){typeof e==='undefined'&&(e=!0);var r=this.urlsplit(t);if(r.scheme){return!e?t:this.urldefrag(t)[0]}var u=this.urlsplit(n);u.scheme||(u.scheme=r.scheme);(!u.netloc||!u.hostname)&&(u.netloc=r.netloc,u.hostname=r.hostname,u.port=r.port);if(r.path.length>0){if(r.path.charAt(0)==='/')u.path=r.path;else{var o=u.path.lastIndexOf('/');o===-1?(u.path=r.path):(u.path=u.path.substr(0,o)+'/'+r.path)}}u.path=this.normalizepath(u.path);u.query=r.query;u.fragment=e?r.fragment:'';return this.urlunsplit(u)}}var l=new a;var h='5.3.0',p={preloadHomepage:!0,cacheHomepage:!1,debug:!1,xhr:{headers:{Accept:'application/hal+json, application/json, */*; q=0.01','X-HyperGard':h}}},d=/^(_embedded|_links|_forms)$/,m=/^(head|get)$/i,g=[].concat,y=Object.keys,j=function(n){return!!n&&{}.toString.call(n)==='[object Object]'},w=function(n){return n.status>=200&&n.status<300?n:Promise.reject(n instanceof Response?n:new Response('',{status:503,statusText:'Possible CORS error'}))},A=function(n){return new Promise(function(t,e){setTimeout(function(){e({error:{code:'0011',msg:'Fetch timeout',timeout:n}})},n)})},b=function(n,t){var e=c({},p.xhr,t);return Promise.race([A(t.timeout||6e4),fetch(n,e)]).then(w)},E=function(n){return Object.keys(n).map(function(t){return encodeURIComponent(t)+'='+encodeURIComponent(n[t])}).join('&')},P=function(n,t){var e,r=!1,u=c({},p,t||{}),o={},i=function(n){var t={};(n||[]).forEach(function(n){n.name&&(t[n.name]=n)});return t},f=function(n,t){var e={};y(n).forEach(function(r){e[r]=Array.isArray(n[r])?n[r].map(function(n){return new w(n,t)}):new w(n[r],t)});return e},a=function(n,t,e,r){var c={},s=((t._links||{}).self||{}).href||'',a=[],l=f(t._embedded||{},n);y(t).forEach(function(n){d.test(n)||(this[n]=t[n])},c);n.getAction=function(n,e){if(!a[n]){a[n]=[];var r=i((t._links||{}).curies),u=i((t._forms||{}).curies),o=String(n).split(':')[0]||'';g.call([],(t._links||{})[n]).forEach(function(t){t&&(t.curie=r[o],a[n].push(new h(this,n,t,e,'link')))},this);g.call([],(t._forms||{})[n]).forEach(function(t){t&&(t.curie=u[o],a[n].push(new h(this,n,t,e,'form')))},this)}return a[n].map(function(n){return n.setParams(e)})};n.getBase=function(){return r||e.getBase()};n.getEmbedded=function(n){return l[n]};n.fetchEmbedded=function(n,t){return this.hasEmbedded(n)?Promise.resolve({data:this.getEmbedded(n)}):this.getFirstAction(n).fetch(t)};n.getFirstAction=function(n,t){return this.getAction(n,t)[0]||new h(this,n,{},{},'none')};n.getParent=function(){return e};n.getProp=function(n){return c[n]};n.getProps=function(){return c};n.hasAction=function(t){return n.hasLink(t)||n.hasForm(t)};n.hasEmbedded=function(n){return!!l[n]};n.hasForm=function(t){return n.listActions().forms.indexOf(t)>=0};n.hasLink=function(t){return n.listActions().links.indexOf(t)>=0};n.listActions=function(){var n=function(n){return n!=='curies'};return{links:y(t._links||{}).filter(n),forms:y(t._forms||{}).filter(n)}};n.listEmbedded=function(){return y(l)};u.debug&&(n.resource=t);r||(n.getRoot=function(){var n;do{n=this.getParent()}while(!(n instanceof A));return n});s&&(o[s]=n)},h=function(n,t,e,r,u){var o=this,i=(e.href||e.action||'').replace(/^#/,''),c=e.method||(u==='form'?'POST':'GET'),f='',a='';o.getActionName=function(){return t};o.getActionType=function(){return u};o.getActionUrl=function(){return f};o.getMethod=function(){return c};o.getParams=function(){return s.extractParams(i)};o.getRawActionUrl=function(){return i};o.getTitle=function(){return e.title||''};o.isTemplated=function(){return e.templated||!1};o.setParams=function(t){f=e.templated?s.expand(i,t||{}):i;f&&(f=l.urljoin(e.curie?e.curie.href:n.getBase(),f));u==='form'&&(e.fields&&j(t)?(a={},y(e.fields).forEach(function(n){t.hasOwnProperty(n)?(a[n]=t[n]):e.fields[n].hasOwnProperty('default')&&(a[n]=e.fields[n]['default'])})):t&&(a=JSON.stringify(t)),m.test(c)&&a&&(f=l.urljoin(f,'?'+E(a)),a=''));return o};u==='form'&&(o.getFields=function(){return e.fields||{}},o.getPayload=function(){return a});e.curie&&(o.getDocUrl=function(){return s.expand(e.curie.href,{rel:t.split(':')[1]})});o.setParams(r)},w=function(n,t){return a(this,n||{},t)},A=function(n,t){return a(this,t,this,n)};h.prototype.fetch=function(n){n||(n={});var t=n.url||this.getActionUrl(),e=this.getRawActionUrl(),r=this.getActionName(),i=this.getPayload?this.getPayload():'',f=c({method:this.getMethod(),action:r},u.xhr,n),s=function(n){if(n.status===204){return Promise.resolve({action:r,data:'',xhr:n})}function e(n){if(!f.returnRawData&&j(n)){return new A(t,n)}return n}return n.json().then(function(t){return{action:r,data:e(t),xhr:n}},function(){return{action:r,data:n.text(),xhr:n}})},a=function(n){return Promise.reject(n instanceof Response?{error:{action:r,code:'0021',msg:'Failed to retrieve action'},xhr:n}:n)};!m.test(f.method)&&j(i)&&(f.headers['Content-Type']='application/x-www-form-urlencoded',f.body=E(i));if(!t){return Promise.reject({error:{action:r,code:'0020',msg:'Url is not provided for this action'}})}else if(f.method==='GET'&&!n.force&&o.hasOwnProperty(e)){return Promise.resolve({action:r,data:o[e]})}return b(t,f).then(s,a)};this.fetch=function(){var t=c({method:'GET',action:'homepage'},u.xhr),o=function(t){u.cacheHomepage||(r=!1);return t.json().then(function(e){return j(e)?{data:new A(n,e),xhr:t}:Promise.reject()})['catch'](function(){return Promise.reject({error:{code:'0002',msg:'Could not parse homepage'},xhr:t})})},i=function(n){r=!1;return Promise.reject(n instanceof Response?{error:{code:'0001',msg:'Failed to retrieve homepage'},xhr:n}:n)};if(!n){return Promise.reject({error:{code:'0000',msg:'API endpoint was not provided'}})}r||(r=!0,e=b(n,t).then(o,i));return e};this.setOptions=function(n){c(u,n||{});return this};this.getOptions=function(){return u};this.parse=function(t){return new A(n,t||{})};u.preloadHomepage&&this.fetch();this.generateResource=function(t){var e=t&&t._links&&t._links.self&&t._links.self.href,r=l.urljoin(n,e);return new A(r,t)}};P.prototype.version=h;function x(n){b=(function(t){return function(e,r){return n(e,r,t)}})(b)}P.prototype.applyMiddlewareStack=function(n){var t;n&&Array.isArray(n)&&n.length&&(t=n.reverse(),t.forEach(x))};return P}))