"use strict";var typeObj={},slice=[].slice,toString=typeObj.toString,getType=function(t){if(t==null){return t+''}return typeof t==='object'||typeof t==='function'?typeObj[toString.call(t)]||'object':typeof t},isSpecificValue=function(t){return getType(t)==='buffer'||getType(t)==='date'||getType(t)==='regexp'},cloneSpecificValue=function(t){var n=getType(t),e;if(n==='buffer'){e=new Buffer(t.length);t.copy(e);return e}if(n==='date'){return new Date(t.getTime())}if(n==='regexp'){return new RegExp(t)}throw new Error('Unexpected situation')},deepCloneArray=function(t){var n=[];t.forEach(function(t,e){getType(t)==='object'?(Array.isArray(t)?(n[e]=deepCloneArray(t)):isSpecificValue(t)?(n[e]=cloneSpecificValue(t)):(n[e]=deepExtend({},t))):(n[e]=t)});return n},deepExtend=function(){if(arguments.length<1||getType(arguments[0])!=='object'){return!1}if(arguments.length<2){return arguments[0]}var t=arguments[0],n=slice.call(arguments,1),e,r;n.forEach(function(n){if(getType(n)!=='object'||Array.isArray(n)){return}Object.keys(n).forEach(function(u){r=t[u];e=n[u];e!==t&&(getType(e)!=='object'||e===null?(t[u]=e):Array.isArray(e)?(t[u]=deepCloneArray(e)):isSpecificValue(e)?(t[u]=cloneSpecificValue(e)):getType(r)!=='object'||r===null||Array.isArray(r)?(t[u]=deepExtend({},e)):(t[u]=deepExtend(r,e)))})});return t};['Boolean','Number','String','Function','Array','Date','RegExp','Object','Error'].forEach(function(t){typeObj["[object "+t+"]"]=t.toLowerCase()});function UrlTemplate(){var t=['+','#','.','/',';','?','&'],n=/\{([^\{\}]+)\}|([^\{\}]+)/g,e=/([^:\*]*)(?::(\d+)|(\*))?/,r=function(t){return t.split(/(%[0-9A-Fa-f]{2})/g).map(function(t){/%[0-9A-Fa-f]/.test(t)||(t=encodeURI(t));return t}).join('')},u=function(t,n,e){n=t==='+'||t==='#'?r(n):encodeURIComponent(n);return e?encodeURIComponent(e)+'='+n:n},o=function(t){return t!==void 0&&t!==null},i=function(t){return t===';'||t==='&'||t==='?'},c=function(t,n,e,r){var c=t[e],f=[];if(typeof c!=='undefined'&&c!==null){if(typeof c==='string'||typeof c==='number'||typeof c==='boolean')c=c.toString(),r&&r!=='*'&&(c=c.substring(0,parseInt(r,10))),f.push(u(n,c,i(n)?e:null));else{if(r==='*')Array.isArray(c)?c.filter(o).forEach(function(t){f.push(u(n,t,i(n)?e:null))}):Object.keys(c).forEach(function(t){o(c[t])&&f.push(u(n,c[t],t))});else{var s=[];Array.isArray(c)?c.filter(o).forEach(function(t){s.push(u(n,t,''))}):Object.keys(c).forEach(function(t){o(c[t])&&(s.push(encodeURIComponent(t)),s.push(u(n,c[t].toString(),'')))});i(n)?f.push(encodeURIComponent(e)+'='+s.join(',')):s.length!==0&&f.push(s.join(','))}}}else n===';'?f.push(encodeURIComponent(e)):c===''&&(n==='&'||n==='?')?f.push(encodeURIComponent(e)+'='):c===''&&f.push('');return f};this.expand=function(u,o){return u.replace(n,function(n,i,f){var s;if(i){var a,l=[];t.indexOf(i.charAt(0))!==-1&&(a=i.charAt(0),i=i.substr(1),(u.match(/\?/g)||[]).length>1&&(a='&'));i.split(/,/g).forEach(function(t){var n=e.exec(t);l.push.apply(l,c(o,a,n[1],n[2]||n[3]))});if(a&&a!=='+'){var h=',';a==='?'?(h='&'):a!=='#'&&(h=a);s=(l.length?a:'')+l.join(h)}else s=l.join(',')}else s=r(f);return s})};this.extractParams=function(e){var r=[];e.replace(n,function(n,e){e&&(t.indexOf(e.charAt(0))!==-1&&(e=e.substr(1)),r=r.concat(e.split(/,/g)))});return r}}var urltemplate=new UrlTemplate;function UrlParse(){var t=/^([A-Za-z]+)?(:?\/\/)([0-9.\-A-Za-z]*)(?::(\d+))?(.*)$/,n=/([^?#]*)?(?:\?([^#]*))?(?:#(.*))?$/;this.normalizepath=function(t){if(!t||t==='/'){return'/'}var n=t.split('/'),e=[];n[0]&&e.push('');n.forEach(function(t){t==='..'?(e.length>1?e.pop():e.push(t)):t!=='.'&&e.push(t)});return e.join('/')||'/'};this.urlnormalize=function(t){var n=this.urlsplit(t);switch(n.scheme){case 'file':n.query='';n.fragment='';break;case 'http':;case 'https':(n.scheme==='http'&&n.port==80||n.scheme==='https'&&n.port==443)&&(delete n.port,n.netloc=n.hostname);break;default:return t}n.path=this.normalizepath(n.path);return this.urlunsplit(n)};this.urldefrag=function(t){var n=t.indexOf('#');return n===-1?[t,'']:[t.substr(0,n),t.substr(n+1)]};this.urlsplit=function(e,r,u){u=u!==!1;var o,i={},c=(e||'').match(t);c?(i.scheme=c[1]||r||'',i.hostname=c[3].toLowerCase()||'',i.port=parseInt(c[4],10)||'',i.netloc=c[3],c[4]&&(i.netloc+=':'+c[4]),o=c[5]):(i.scheme=r||'',i.netloc='',i.hostname='',o=e);i.scheme=i.scheme.toLowerCase();c=o.match(n);i.path=c[1]||'';i.query=c[2]||'';i.fragment=u?c[3]||'':'';return i};this.urlunsplit=function(t){var n='';t.scheme&&(n+=t.scheme+'://');t.netloc?(n===''&&(n+='//'),n+=t.netloc):t.hostname&&(n===''&&(n+='//'),n+=t.hostname,t.port&&(n+=':'+t.port));t.path&&(n+=t.path);t.query&&(n+='?'+t.query);t.fragment&&(n+='#'+t.fragment);return n};this.urljoin=function(t,n,e){typeof e==='undefined'&&(e=!0);var r=this.urlsplit(n);if(r.scheme){return!e?n:this.urldefrag(n)[0]}var u=this.urlsplit(t);u.scheme||(u.scheme=r.scheme);(!u.netloc||!u.hostname)&&(u.netloc=r.netloc,u.hostname=r.hostname,u.port=r.port);if(r.path.length>0){if(r.path.charAt(0)==='/')u.path=r.path;else{var o=u.path.lastIndexOf('/');o===-1?(u.path=r.path):(u.path=u.path.substr(0,o)+'/'+r.path)}}u.path=this.normalizepath(u.path);u.query=r.query;u.fragment=e?r.fragment:'';return this.urlunsplit(u)}}var urlparse=new UrlParse;var version='5.2.0',defaultOptions={preloadHomepage:!0,cacheHomepage:!1,debug:!1,xhr:{headers:{Accept:'application/hal+json, application/json, */*; q=0.01','X-HyperGard':version}}},excludedProps=/^(_embedded|_links|_forms)$/,excludeBody=/^(head|get)$/i,concat=[].concat,keys=Object.keys,isObject=function(t){return!!t&&{}.toString.call(t)==='[object Object]'},xhrStatus=function(t){return t.status>=200&&t.status<300?t:Promise.reject(t instanceof Response?t:new Response('',{status:503,statusText:'Possible CORS error'}))},xhrTimeout=function(t){return new Promise(function(n,e){setTimeout(function(){e({error:{code:'0011',msg:'Fetch timeout',timeout:t}})},t)})},load=function(t,n){var e=deepExtend({},defaultOptions.xhr,n);return Promise.race([xhrTimeout(n.timeout||6e4),fetch(t,e)]).then(xhrStatus)},urlSerialize=function(t){return Object.keys(t).map(function(n){return encodeURIComponent(n)+'='+encodeURIComponent(t[n])}).join('&')},HyperGard=function(t,n){var e,r=!1,u=deepExtend({},defaultOptions,n||{}),o={},i=function(t){var n={};(t||[]).forEach(function(t){t.name&&(n[t.name]=t)});return n},c=function(t,n){var e={};keys(t).forEach(function(r){e[r]=Array.isArray(t[r])?t[r].map(function(t){return new a(t,n)}):new a(t[r],n)});return e},f=function(t,n,e,r){var f={},a=((n._links||{}).self||{}).href||'',h=[],p=c(n._embedded||{},t);keys(n).forEach(function(t){excludedProps.test(t)||(this[t]=n[t])},f);t.getAction=function(t,e){if(!h[t]){h[t]=[];var r=i((n._links||{}).curies),u=i((n._forms||{}).curies),o=String(t).split(':')[0]||'';concat.call([],(n._links||{})[t]).forEach(function(n){n&&(n.curie=r[o],h[t].push(new s(this,t,n,e,'link')))},this);concat.call([],(n._forms||{})[t]).forEach(function(n){n&&(n.curie=u[o],h[t].push(new s(this,t,n,e,'form')))},this)}return h[t].map(function(t){return t.setParams(e)})};t.getBase=function(){return r||e.getBase()};t.getEmbedded=function(t){return p[t]};t.fetchEmbedded=function(t,n){return this.hasEmbedded(t)?Promise.resolve({data:this.getEmbedded(t)}):this.getFirstAction(t).fetch(n)};t.getFirstAction=function(t,n){return this.getAction(t,n)[0]||new s(this,t,{},{},'none')};t.getParent=function(){return e};t.getProp=function(t){return f[t]};t.getProps=function(){return f};t.hasAction=function(n){return t.hasLink(n)||t.hasForm(n)};t.hasEmbedded=function(t){return!!p[t]};t.hasForm=function(n){return t.listActions().forms.indexOf(n)>=0};t.hasLink=function(n){return t.listActions().links.indexOf(n)>=0};t.listActions=function(){var t=function(t){return t!=='curies'};return{links:keys(n._links||{}).filter(t),forms:keys(n._forms||{}).filter(t)}};t.listEmbedded=function(){return keys(p)};u.debug&&(t.resource=n);r||(t.getRoot=function(){var t;do{t=this.getParent()}while(!(t instanceof l));return t});a&&(o[a]=t)},s=function(t,n,e,r,u){var o=this,i=(e.href||e.action||'').replace(/^#/,''),c=e.method||(u==='form'?'POST':'GET'),f='',s='';o.getActionName=function(){return n};o.getActionType=function(){return u};o.getActionUrl=function(){return f};o.getMethod=function(){return c};o.getParams=function(){return urltemplate.extractParams(i)};o.getRawActionUrl=function(){return i};o.getTitle=function(){return e.title||''};o.isTemplated=function(){return e.templated||!1};o.setParams=function(n){f=e.templated?urltemplate.expand(i,n||{}):i;f&&(f=urlparse.urljoin(e.curie?e.curie.href:t.getBase(),f));u==='form'&&(e.fields&&isObject(n)?(s={},keys(e.fields).forEach(function(t){n.hasOwnProperty(t)?(s[t]=n[t]):e.fields[t].hasOwnProperty('default')&&(s[t]=e.fields[t]['default'])})):n&&(s=JSON.stringify(n)),excludeBody.test(c)&&s&&(f=urlparse.urljoin(f,'?'+urlSerialize(s)),s=''));return o};u==='form'&&(o.getFields=function(){return e.fields||{}},o.getPayload=function(){return s});e.curie&&(o.getDocUrl=function(){return urltemplate.expand(e.curie.href,{rel:n.split(':')[1]})});o.setParams(r)},a=function(t,n){return f(this,t||{},n)},l=function(t,n){return f(this,n,this,t)};s.prototype.fetch=function(t){t||(t={});var n=t.url||this.getActionUrl(),e=this.getRawActionUrl(),r=this.getActionName(),i=this.getPayload?this.getPayload():'',c=deepExtend({method:this.getMethod(),action:r},u.xhr,t),f=function(t){if(t.status===204){return Promise.resolve({action:r,data:'',xhr:t})}function e(t){if(!c.returnRawData&&isObject(t)){return new l(n,t)}return t}return t.json().then(function(n){return{action:r,data:e(n),xhr:t}},function(){return{action:r,data:t.text(),xhr:t}})},s=function(t){return Promise.reject(t instanceof Response?{error:{action:r,code:'0021',msg:'Failed to retrieve action'},xhr:t}:t)};!excludeBody.test(c.method)&&isObject(i)&&(c.headers['Content-Type']='application/x-www-form-urlencoded',c.body=urlSerialize(i));if(!n){return Promise.reject({error:{action:r,code:'0020',msg:'Url is not provided for this action'}})}else if(c.method==='GET'&&!t.force&&o.hasOwnProperty(e)){return Promise.resolve({action:r,data:o[e]})}return load(n,c).then(f,s)};this.fetch=function(){var n=deepExtend({method:'GET',action:'homepage'},u.xhr),o=function(n){u.cacheHomepage||(r=!1);return n.json().then(function(e){return isObject(e)?{data:new l(t,e),xhr:n}:Promise.reject()})['catch'](function(){return Promise.reject({error:{code:'0002',msg:'Could not parse homepage'},xhr:n})})},i=function(t){r=!1;return Promise.reject(t instanceof Response?{error:{code:'0001',msg:'Failed to retrieve homepage'},xhr:t}:t)};if(!t){return Promise.reject({error:{code:'0000',msg:'API endpoint was not provided'}})}r||(r=!0,e=load(t,n).then(o,i));return e};this.setOptions=function(t){deepExtend(u,t||{});return this};this.getOptions=function(){return u};this.parse=function(n){return new l(t,n||{})};u.preloadHomepage&&this.fetch()};HyperGard.prototype.version=version;function applyMiddleware(t){load=(function(n){return function(e,r){return t(e,r,n)}})(load)}HyperGard.prototype.applyMiddlewareStack=function(t){var n;t&&Array.isArray(t)&&t.length&&(n=t.reverse(),n.forEach(applyMiddleware))};export default HyperGard